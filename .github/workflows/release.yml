name: Release Images

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ghcr.io/badgerops/grapheon-backend
  IMAGE_FRONTEND: ghcr.io/badgerops/grapheon-frontend

jobs:
  backend-image:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    if: startsWith(github.event.release.tag_name, 'backend-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract version
        id: version
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: echo "version=${TAG_NAME#backend-v}" >> $GITHUB_OUTPUT

      - name: Verify backend version
        run: |
          file_version=$(cat backend/VERSION)
          if [ "$file_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "backend/VERSION ($file_version) does not match tag (${{ steps.version.outputs.version }})"
            exit 1
          fi
          python scripts/validate_versions.py

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_BACKEND }}:latest
            ${{ env.IMAGE_BACKEND }}:v${{ steps.version.outputs.version }}

  frontend-image:
    name: Build & Push Frontend
    runs-on: ubuntu-latest
    if: startsWith(github.event.release.tag_name, 'frontend-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract version
        id: version
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: echo "version=${TAG_NAME#frontend-v}" >> $GITHUB_OUTPUT

      - name: Verify frontend version
        run: |
          package_version=$(python - <<'PY'
          import json
          from pathlib import Path
          print(json.loads(Path('frontend/package.json').read_text())['version'])
          PY
          )
          if [ "$package_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "frontend/package.json ($package_version) does not match tag (${{ steps.version.outputs.version }})"
            exit 1
          fi
          python scripts/validate_versions.py

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_FRONTEND }}:latest
            ${{ env.IMAGE_FRONTEND }}:v${{ steps.version.outputs.version }}
